# Riz - 模块参考

**目的:** 本文档深入介绍 Riz 固件中的软件模块。

**受众:** 固件开发人员。

---

## 目录

- [Riz - 模块参考](#yoach-1---模块参考)
  - [目录](#目录)
  - [概述](#概述)
  - [核心组件与模块](#核心组件与模块)
    - [1. 主应用程序 (`main.cpp`)](#1-主应用程序-maincpp)
    - [2. BluetoothControl](#2-bluetoothcontrol)
    - [3. LightControl](#3-lightcontrol)
    - [4. DataControl](#4-datacontrol)
    - [5. 传感器模块](#5-传感器模块)
    - [6. 电池监测 (Pangodream_18650_CL)](#6-电池监测-pangodream_18650_cl)
    - [7. OTA 模块](#7-ota-模块)
    - [8. 日志系统](#8-日志系统)
    - [9. 全局变量与配置 (`Global_VAR.h`)](#9-全局变量与配置-global_varh)
  - [FreeRTOS 任务](#freertos-任务)

## 概述

固件分为多个关键模块,每个模块负责设备功能的特定方面。这些模块相互交互以实现整体系统行为,通过 FreeRTOS 任务实现并发协调。

---

## 核心组件与模块

### 1. 主应用程序 (`main.cpp`)

*   **说明:** 固件的主入口点。处理系统初始化、硬件外设配置、FreeRTOS 任务的创建和管理,以及包含主要处理循环逻辑 (`ProcessingTask`)。
*   **职责:**
    *   系统启动和配置。
    *   所有其他模块的初始化(蓝牙、光控、数据、传感器、电池)。
    *   FreeRTOS 任务的创建 (`ProcessingTask`、`TOFSensorTask`、`MMWaveSensorTask`、`LightControlTask`)。
    *   不同任务和模块之间的协调。
*   **相关文件:** `src/main.cpp`

### 2. BluetoothControl

*   **职责:**
    *   管理蓝牙低功耗 (BLE) 栈 (服务器角色)。
    *   处理 BLE 连接生命周期 (广告、连接、断开)。
    *   接收来自连接的 BLE 客户端 (如移动应用) 的命令和配置数据。
    *   将状态更新和传感器数据发送回客户端。
    *   便于基于 BLE 的无线固件更新 (OTA)。
*   **主要公开函数/方法 (示意):**
    *   `init()`: 初始化 BLE 服务、特征和广告。
    *   `start_advertising()`: 开始 BLE 广告。
    *   `send_notification(data)`: 通过 BLE 通知将数据发送到连接的客户端。
    *   `register_command_callback(callback_func)`: 允许其他模块 (如 DataControl) 注册传入命令通知。
    *   `register_ota_handler(ota_module)`: 链接 OTA 模块以处理更新请求。
*   **重要内部逻辑:**
    *   使用 ESP-IDF BLE 库 (GATT 服务器实现,基于 NimBLE 的常见做法)。
    *   管理特征读写权限和回调。
    *   处理连接参数和安全性。
*   **交互:**
    *   `DataControl`: 发送接收到的命令/数据进行处理。
    *   `OTA Module`: 收到特定 BLE 命令/数据时触发 OTA 过程。
    *   `Log System`: 使用日志记录调试 BLE 事件。
    *   `ProcessingTask`: 可能接收通过 `DataControl` 中继的命令。
*   **相关文件:** `src/BluetoothControl.cpp`、`include/BluetoothControl.h` (可能 `src/otaCallback.cpp`、`include/otaCallback.h` 如果 OTA 单独处理)

### 3. LightControl

*   **职责:**
    *   控制 RGB LED 灯条 (可能是 NeoPixel 或类似产品)。
    *   管理 LED 亮度。
    *   实现各种光效果 (`manualWipe`、`rhythmWipe`、`connectedWipe` 等),对应不同的游戏模式和反馈事件。
    *   控制蜂鸣器以获得听觉反馈。
*   **主要公开函数/方法 (示意):**
    *   `init(led_pin, num_pixels, buzzer_pin)`: 初始化 LED 灯条和蜂鸣器引脚。
    *   `set_brightness(level)`: 设置总体亮度。
    *   `set_effect(effect_enum, color, speed)`: 启动特定的预定义光效果。
    *   `set_pixel(index, color)`: 设置单个像素的颜色。
    *   `show()`: 用当前状态更新物理 LED 灯条。
    *   `play_buzzer(duration_ms)`: 在指定时间内激活蜂鸣器。
*   **重要内部逻辑:**
    *   使用 Adafruit_NeoPixel 或 FastLED 等库。
    *   维护像素状态的内部缓冲区。
    *   复杂效果生成可能在 `LightControlTask` 中处理或通过计时器进行非阻塞操作。
*   **交互:**
    *   `DataControl`: 接收设置 (模式、颜色、亮度) 和效果触发。
    *   `ProcessingTask`: 指示 `LightControl` 根据游戏逻辑显示特定反馈。
    *   `LightControlTask`: 处理光效果的执行和时序。
    *   `Log System`: 记录效果变化或错误。
*   **相关文件:** `src/LightControl.cpp`、`include/LightControl.h`

### 4. DataControl

*   **职责:**
    *   充当管理设备状态、游戏模式和配置参数的中央存储库和枢纽。
    *   解析和验证传入的 BLE 消息/命令。
    *   维护当前 `gameMode` 和相关设置 (例如 `blinkBreak`、`timedBreak`、`sensorMode`、RGB 值)。
    *   处理从传感器模块/任务接收的传感器数据/事件。
    *   协调不同游戏模式之间的状态转换。
*   **主要公开函数/方法 (示意):**
    *   `init()`: 初始化默认设置和状态。
    *   `process_ble_command(command_data)`: 解析从 `BluetoothControl` 接收到的命令。
    *   `set_game_mode(mode_enum)`: 更改活跃的游戏模式。
    *   `get_game_mode()`: 返回当前游戏模式。
    *   `update_setting(setting_name, value)`: 更新配置参数。
    *   `process_tof_event(distance)`: 处理来自 TOF 传感器的检测事件。
    *   `process_radar_event(detection_type)`: 处理来自毫米波传感器的检测事件。
*   **重要内部逻辑:**
    *   游戏模式和转换的状态机实现。
    *   BLE 命令格式的解析逻辑 (例如自定义字符串格式、JSON)。
    *   配置参数的存储和检索 (可能使用 NVS - 非易失性存储)。
*   **交互:**
    *   `BluetoothControl`: 接收来自 BLE 的命令。
    *   `LightControl`: 发送更新的设置 (颜色、亮度) 并根据模式或事件触发光/蜂鸣器效果。
    *   `Sensor Modules` / 传感器任务 (`TOFSensorTask`、`MMWaveSensorTask`): 接收处理的检测事件。
    *   `ProcessingTask`: 与主游戏逻辑任务协调。
*   **相关文件:** `src/DataControl.cpp`、`include/DataControl.h`

### 5. 传感器模块

这是传感器驱动程序及其相关处理任务的逻辑分组。

*   **5.a TF-Luna (TOF 传感器)**
    *   **职责:** 与 TF-Luna 飞行时间传感器 (通过 UART 或 I2C) 交互、读取距离/振幅、执行基线校准、根据阈值 (包括冷却) 检测事件。
    *   **主要函数/方法 (示意 - 驱动程序/任务的一部分):**
        *   `init(uart_num/i2c_addr)`: 初始化与传感器的通信。
        *   `read_distance()`: 获取当前距离读数。
        *   `isObjectDetected()`: 返回检测状态。
        *   `configure_threshold(min_dist, max_dist)`: 设置检测区域。
    *   **重要内部逻辑:** 处理串行/I2C 通信协议、数据解析、错误检查。在 `TOFSensorTask` 中运行以进行非阻塞读取。
    *   **交互:** `TOFSensorTask` 读取数据;向 `DataControl` / `ProcessingTask` 发送检测事件。
    *   **相关文件:** `src/TF_Luna_UART.cpp`、`include/TF_Luna_UART.h`
*   **5.b MMWave (雷达传感器)**
    *   **职责:** 与毫米波雷达模块 (可能是 UART) 交互、配置参数、解析数据 (存在、运动)、实现检测逻辑。
    *   **主要函数/方法 (示意 - 驱动程序/任务的一部分):**
        *   `init(uart_num)`: 初始化通信。
        *   `configure_radar(params)`: 发送配置命令。
        *   `isObjectDetected()`: 返回检测状态。
        *   `process_radar_data(raw_data)`: 解析传入的数据流。
    *   **重要内部逻辑:** 处理特定于雷达的通信协议和数据结构。可能涉及信号处理。在 `MMWaveSensorTask` 中运行。
    *   **交互:** `MMWaveSensorTask` 读取和处理数据;向 `DataControl` / `ProcessingTask` 发送检测事件。
    *   **相关文件:** `src/MMWave.cpp`、`include/MMWave.h`

### 6. 电池监测 (Pangodream_18650_CL)

*   **职责:**
    *   通过 ADC 监测 (假定) 18650 锂离子电池的电压。
    *   计算预期剩余电池百分比。
    *   提供过滤后的电池状态信息。
*   **主要公开函数/方法 (示意):**
    *   `init(adc_pin)`: 初始化用于电压读取的 ADC 引脚。
    *   `get_voltage()`: 读取当前电池电压。
    *   `get_battery_percentage()`: 计算并返回预期充电等级 (过滤)。
*   **重要内部逻辑:**
    *   使用 ESP32 ADC 外设。
    *   必要时应用分压器计算。
    *   使用特定于锂离子电池的电压到百分比映射曲线。
*   **交互:**
    *   `main.cpp` / `ProcessingTask`: 定期查询电池状态。
    *   `BluetoothControl`: 可能将电池电平通知发送给客户端。
*   **相关文件:** `include/Pangodream_18650_CL.h` (实现可能在此库的头文件中)

### 7. OTA 模块

*   **职责:**
    *   处理通过 BLE 启动的无线固件更新过程。
    *   接收固件二进制文件块。
    *   将新的固件映像写入 flash 存储器中的相应 OTA 分区。
    *   验证更新并配置引导加载程序在下次重启时切换到新映像。
*   **主要公开函数/方法 (示意):**
    *   `begin()`: 启动 OTA 更新过程。
    *   `write(data, length)`: 写入固件数据块。
    *   `end()`: 完成更新、验证并设置下次启动分区。
*   **重要内部逻辑:**
    *   使用 ESP-IDF OTA 更新 API (`esp_ota_...`)。
    *   管理 flash 分区和引导加载程序配置。
    *   失败更新的错误处理。
*   **交互:**
    *   `BluetoothControl`: 接收固件数据并通过注册的处理程序触发 OTA 过程。
*   **相关文件:** (可能 `src/otaCallback.cpp`、`include/otaCallback.h` 或集成在 `BluetoothControl` 内)

### 8. 日志系统

*   **职责:**
    *   为日志消息 (DEBUG、INFO、WARNING、ERROR) 提供统一的结构化界面。
    *   将日志消息输出到指定目标 (例如串口监视器)。
*   **主要公开函数/方法 (示意):**
    *   `init()`: 初始化日志后端 (例如 UART)。
    *   `log(level, tag, message, ...)`: 格式化并输出日志消息。
    *   便利宏,如 `LOG_INFO(tag, ...)`、`LOG_ERROR(tag, ...)`,基于 ESP-IDF 日志记录。
*   **重要内部逻辑:**
    *   包装 ESP-IDF 日志框架 (`esp_log_...`) 或实现自定义解决方案。
    *   处理消息格式化和输出路由。控制日志级别。
*   **交互:**
    *   *所有其他模块*: 使用日志系统输出诊断信息。
*   **相关文件:** `src/Log.cpp`、`include/Log.h`

### 9. 全局变量与配置 (`Global_VAR.h`)

*   **说明:** 一个中央头文件,定义项目中使用的常数、引脚分配、UUID、默认值和其他全局配置。
*   **职责:**
    *   定义硬件引脚映射 (例如 `RGB_LED_PIN`、传感器引脚)。
    *   定义 BLE 服务和特征 UUID。
    *   设置默认操作参数 (例如 `DEFAULT_GAMEMODE`、`LED_COUNT`)。
    *   定义游戏模式、枚举和配置键的常数。
*   **相关文件:** `include/Global_VAR.h`

---

## FreeRTOS 任务

系统使用 FreeRTOS 实时操作系统来管理并发操作。任务被定义、分配优先级和核心关联性,并使用 RTOS 原语进行交互。

*   **`ProcessingTask`:**
    *   主应用程序逻辑循环。根据来自 `DataControl` 的输入处理高级状态转换 (游戏模式)。
    *   协调模块之间的操作 (例如告诉 `LightControl` 效果、请求传感器运行)。在核心 0 上运行。
*   **`TOFSensorTask`:**
    *   专门用于定期读取和处理 TF-Luna 传感器的数据 (当被请求时)。向 `DataControl` 发送事件/数据。在核心 1 上运行以进行时间关键的操作。
*   **`MMWaveSensorTask`:**
    *   专门用于读取/解析毫米波传感器的数据 (当被请求时)。向 `DataControl` 发送事件。在核心 1 上运行。
*   **`LightControlTask`:**
    *   管理复杂或持续光/蜂鸣器效果的时序和执行,确保平滑动画而不阻塞其他任务。在核心 0 上运行。
*   **(BLE 栈任务):** 由 ESP-IDF BLE 栈管理的底层任务 (可能是 NimBLE),处理低级 BLE 操作。通常在核心 0 上运行。
*   **(计时器任务等):** 由 ESP-IDF/Arduino 核心为计时器和其他系统服务管理的后台任务。
*   **并发控制:** 使用 RTOS 原语,如互斥锁 (`xSensorMutex`、`xMMWaveMutex`、`xObjectDetectedMutex`),以安全访问任务之间的共享资源 (标志、数据) (特别是 `ProcessingTask` 和传感器任务之间)。
*   **相关文件:** 任务定义主要在 `src/main.cpp` 中。RTOS 原语的使用发生在任务中访问共享资源的各处。

---

*注: 函数名称和特定实现细节是示意性的,取决于实际代码库。*
