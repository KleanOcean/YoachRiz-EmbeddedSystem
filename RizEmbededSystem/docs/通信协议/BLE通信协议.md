# Yoach1 蓝牙通信协议规范 v0.0.2

## 目录
- [概述](#概述)
- [BLE服务和特征](#ble服务和特征)
- [设备命名规则](#设备命名规则)
- [游戏模式定义](#游戏模式定义)
- [消息格式](#消息格式)
- [配置参数](#配置参数)
- [颜色显示逻辑](#颜色显示逻辑)
- [传感器集成](#传感器集成)
- [错误处理](#错误处理)
- [调试和日志](#调试和日志)

---

## 概述

本文档描述了Yoach1设备使用的低功耗蓝牙(BLE)通信协议。该协议定义了移动应用程序与嵌入式设备之间的消息结构、处理和交互方式。

**协议版本**: 0.0.2
**最后更新**: 2024年11月23日
**目标读者**: 移动应用开发人员(iOS/Android)、测试人员、固件开发人员

---

## BLE服务和特征

### 服务UUID
- **主服务UUID**: `ab0828b1-198e-4351-b779-901fa0e0371e`

### 特征(Characteristics)

| 特征名称 | UUID | 属性 | 用途 |
|---------|------|------|------|
| **消息特征** | `4ac8a696-9736-4e5d-932b-e9b31405049c` | WRITE, NOTIFY | 发送命令和接收通知 |
| **TX特征** | `62ec0272-3ec5-11eb-b378-0242ac130003` | NOTIFY | 辅助通知 |
| **OTA特征** | `62ec0272-3ec5-11eb-b378-0242ac130005` | WRITE_NR | 固件更新 |

---

## 设备命名规则

设备使用以下格式命名：`PRO-XXXX`

其中`XXXX`源自ESP32的唯一MAC地址。

---

## 游戏模式定义

### 模式列表

| 模式ID | 宏定义名称 | 中文名称 | 英文名称 | 说明 |
|--------|-----------|---------|----------|------|
| **1** | MANUAL_MODE | 手动模式 | Manual | TOF传感器检测，颜色基于process值 |
| **2** | RANDOM_MODE | 随机模式 | Random | 随机选择颜色(绿/黄/红) |
| **3** | TIMED_MODE | 定时模式 | Timed | MMWave雷达检测，带超时功能 |
| **4** | DOUBLE_MODE | 双人模式 | Double | 基于索引的双色模式 |
| **5** | RHYTHM_MODE | 节奏模式 | Rhythm | 自定义RGB颜色控制 |
| **6** | MOVEMENT_MODE | 移动模式 | Movement | (未实现) |
| **11** | OPENING_MODE | 开启模式 | Opening | 系统初始化序列 |
| **12** | CLOSING_MODE | 关闭模式 | Closing | 系统关闭序列 |
| **13** | TERMINATE_MODE | 终止模式 | Terminate | 紧急停止 |
| **14** | RESTTIMESUP_MODE | 休息结束 | Rest Complete | 休息时间结束提示 |
| **99** | PROCESSED_MODE | 已处理 | Processed | 内部状态，表示命令已处理 |
| **100** | CONFIG_MODE | 配置模式 | Config | 配置闪烁次数 |

### 模式转换逻辑

```
客户端发送命令 → 设备接收 → 模式转换 → 执行相应动作 → 发送通知
```

模式转换时的日志格式：
```
[DATA][INFO] Mode transition: PROCESSED(99) → RANDOM(2)
[MAIN][INFO] Mode transition: OPENING(11) → PROCESSED(99)
```

---

## 消息格式

### 标准消息格式（8字段）

所有命令均采用CSV格式，包含8个字段：

```
gameMode,param1,param2,param3,param4,param5,param6,param7
```

### 各模式的消息格式

#### 1. 标准模式 (模式1-4)
```
格式: gameMode,blinkBreak,timedBreak,buzzer,buzzerTime,buffer,doubleModeIndex,process
```

**字段说明**：
- `gameMode`: 游戏模式ID
- `blinkBreak`: 闪烁间隔(ms)
- `timedBreak`: 超时时间(ms)
- `buzzer`: 蜂鸣器开关(0/1)
- `buzzerTime`: 蜂鸣器持续时间(ms)
- `buffer`: 缓冲区大小
- `doubleModeIndex`: 双人模式索引
- `process`: 处理标志(0-100)

**示例**：
```
1,999,999,999,999,999,999,50   # 手动模式，process=50
2,999,999,999,999,999,999,999   # 随机模式
3,999,5000,999,999,999,999,999  # 定时模式，5秒超时
4,999,999,999,999,999,0,999     # 双人模式，索引0
```

#### 2. 节奏模式 (模式5)
```
格式: 5,red,green,blue,timerValue,buzzerValue,sensorMode,placeholder
```

**字段说明**：
- `red`: 红色值 (0-255)
- `green`: 绿色值 (0-255)
- `blue`: 蓝色值 (0-255)
- `timerValue`: 自动关闭定时器(ms)，0表示不自动关闭
- `buzzerValue`: 蜂鸣器时间(ms)，0表示禁用
- `sensorMode`: 传感器模式
  - 0: 无传感器
  - 1: 仅LiDAR
  - 2: 仅MMWave
  - 3: 两个传感器
- `placeholder`: 占位符，必须为999

**示例**：
```
5,255,0,0,0,500,1,999      # 纯红色，0.5秒蜂鸣器，LiDAR检测
5,0,255,0,3000,0,0,999     # 纯绿色，3秒定时器，无传感器
5,0,0,255,0,0,2,999        # 纯蓝色，MMWave检测
5,255,255,0,0,1000,3,999   # 黄色，1秒蜂鸣器，双传感器
```

#### 3. 配置模式 (模式100)
```
格式: 100,blinkCount,999,999,999,999,999,999
```

**字段说明**：
- `blinkCount`: 闪烁次数

**示例**：
```
100,4,999,999,999,999,999,999  # 闪烁4次
```

#### 4. 系统模式 (模式11,12,13)
```
格式: modeID,999,999,999,999,999,999,999
```

**示例**：
```
11,999,999,999,999,999,999,999  # 开启模式
12,999,999,999,999,999,999,999  # 关闭模式
13,999,999,999,999,999,999,999  # 终止模式
```

### 设备通知格式

设备通过BLE特征发送以下通知：

| 通知消息 | 触发条件 | 说明 |
|---------|---------|------|
| `manual` | 手动模式TOF检测到物体 | 手动模式触发 |
| `random` | 随机模式TOF检测到物体 | 随机模式触发 |
| `timed` | 定时模式MMWave检测到物体 | 定时模式触发 |
| `rhythm` | 节奏模式传感器检测到物体 | 节奏模式触发 |
| `double<index>` | 双人模式检测 | 带索引的双人模式触发 |
| `Timed Mode Overtimed` | 定时模式超时 | 超时未检测到物体 |
| `configDone:<count>` | 配置完成 | 配置模式完成 |

---

## 配置参数

### 参数定义

| 参数名 | 说明 | 默认值 | 有效范围 | 单位 |
|-------|------|--------|---------|------|
| **blinkBreak** | 闪烁间隔时间 | 500 | 100-10000 | ms |
| **timedBreak** | 定时模式超时时间 | 500 | 1000-60000 | ms |
| **buzzer** | 蜂鸣器开关 | 1 | 0-1 | - |
| **buzzerTime** | 蜂鸣器持续时间 | 500 | 100-2000 | ms |
| **buffer** | 传感器灵敏度缓冲 | 500 | 1-1000 | - |
| **doubleModeIndex** | 双人模式索引 | 0 | 0-9 | - |
| **process** | 处理进度标志 | 0 | 0-100 | % |
| **mmWaveStrength** | MMWave信号强度阈值 | 200 | 50-500 | - |
| **mmWaveDistance** | MMWave检测距离 | 20 | 10-200 | cm |
| **sensorMode** | 传感器选择模式 | 0 | 0-3 | - |

---

## 颜色显示逻辑

### 预定义颜色表

| 颜色名称 | RGB值 | 使用场景 |
|---------|-------|---------|
| **浅蓝色** | (209, 231, 242) | 手动模式(高process)、定时模式 |
| **天蓝色** | (0, 255, 255) | 手动模式(中process) |
| **深蓝色** | (0, 0, 178) | 手动模式(低process)、双人模式、开启模式 |
| **橙色** | (229, 75, 0) | 双人模式(索引0)、定时模式 |
| **绿色** | (0, 255, 0) | 随机模式选项1 |
| **黄色** | (255, 140, 0) | 随机模式选项2 |
| **红色** | (255, 0, 0) | 随机模式选项3 |
| **樱桃红** | (121, 6, 4) | 关闭模式 |
| **网球黄绿** | (198, 237, 44) | 休息结束、蓝牙连接 |
| **白色** | (255, 255, 255) | 配置模式 |
| **灰色** | (120, 120, 120) | 随机模式第二条带 |

### 各模式颜色逻辑

#### 手动模式 (MANUAL_MODE)
```cpp
process > 50  → 浅蓝色 (209, 231, 242)
process > 25  → 天蓝色 (0, 255, 255)
process ≤ 25  → 深蓝色 (0, 0, 178)
```

#### 随机模式 (RANDOM_MODE)
```cpp
随机选择:
  0 → 绿色 (0, 255, 0)
  1 → 黄色 (255, 140, 0)
  2 → 红色 (255, 0, 0)
第二条带 → 灰色 (120, 120, 120)
```

#### 定时模式 (TIMED_MODE)
```cpp
process > 50  → 浅蓝色 (209, 231, 242)
process > 25  → 橙色 (229, 75, 0)
process ≤ 25  → 深蓝色 (0, 0, 178)
然后逐个像素渐暗至关闭
```

#### 双人模式 (DOUBLE_MODE)
```cpp
doubleModeIndex == 0 → 橙色 (229, 75, 0)
doubleModeIndex != 0 → 深蓝色 (0, 0, 178)
```

#### 节奏模式 (RHYTHM_MODE)
```cpp
使用BLE消息中的RGB值
RGB(redValue, greenValue, blueValue)
```

#### 开启模式 (OPENING_MODE)
```cpp
序列动画:
1. 深蓝色 (0, 0, 178) - 渐亮
2. 浅蓝色 (209, 231, 242) - 渐亮
3. 深蓝色 (0, 0, 178) - 渐亮
4. 关闭
```

#### 关闭模式 (CLOSING_MODE)
```cpp
重复3次:
  樱桃红 (121, 6, 4) - 开启
  延时 100ms
  关闭
  延时 300ms
```

#### 休息结束模式 (RESTTIMESUP_MODE)
```cpp
网球黄绿 (198, 237, 44) 最大亮度
然后逐渐关闭像素
```

### 动画模式

| 动画类型 | 说明 | 使用模式 |
|---------|------|---------|
| **扫描** | 像素顺序点亮 | 开启、连接 |
| **渐暗** | 像素顺序熄灭 | 定时、休息 |
| **闪烁** | 开/关交替 | 关闭 |
| **固定** | 所有像素同色 | 手动、节奏 |

---

## 传感器集成

### TOF传感器 (LiDAR)

**用途**: 物体检测，主要用于手动和随机模式

**工作流程**:
1. 基线测量 (开启模式时)
2. 持续检测
3. 检测到物体时触发
4. 发送通知
5. 重置检测状态

**配置参数**:
- 基线阈值因子: 1.04
- 冷却时间: 400ms
- 连续读取数: 3

### MMWave雷达

**用途**: 运动检测，主要用于定时模式

**工作流程**:
1. 启动检测
2. 范围内物体检测
3. 触发并停止
4. 发送通知

**配置参数**:
- 信号强度阈值: 200
- 检测距离: 20cm
- 处理延迟: 0ms

### 传感器模式选择

节奏模式下的传感器配置：

| sensorMode值 | 配置 | 说明 |
|-------------|------|------|
| 0 | 无传感器 | 仅依靠定时器 |
| 1 | 仅LiDAR | 只使用TOF传感器 |
| 2 | 仅MMWave | 只使用雷达 |
| 3 | 双传感器 | 两个传感器都激活 |

---

## 错误处理

### 错误类型

| 错误代码 | 说明 | 处理方式 |
|---------|------|---------|
| `INVALID_CMD` | 无效命令格式 | 忽略命令，保持当前状态 |
| `INVALID_PARAM` | 参数超出范围 | 使用默认值或限制到有效范围 |
| `INVALID_MODE` | 无效的模式ID | 记录错误，不执行切换 |
| `SENSOR_FAIL` | 传感器故障 | 记录错误，尝试重新初始化 |

### 错误恢复

1. **命令格式错误**:
   - 检查CSV字段数量
   - 验证第一个字段是有效模式ID
   - 记录错误: `[ERROR][DATA] Invalid message format`

2. **参数验证**:
   - RGB值: 限制在0-255
   - 定时器值: 限制在有效范围
   - 传感器模式: 限制在0-3

3. **传感器故障**:
   - 自动重试初始化
   - 降级到无传感器模式
   - 通过蜂鸣器提示用户

---

## 调试和日志

### 日志级别

| 级别 | 宏定义 | 用途 |
|------|--------|------|
| DEBUG | `LOG_DEBUG` | 详细调试信息 |
| INFO | `LOG_INFO` | 一般信息 |
| WARN | `LOG_WARN` | 警告信息 |
| ERROR | `LOG_ERROR` | 错误信息 |

### 调试标志

在`Global_VAR.h`中定义：
```cpp
#define DEBUGGER 0        // GPIO和心跳日志控制
#define DEBUG_SENSOR 1    // 传感器调试信息
```

### 常见日志格式

```
[时间戳][模块][级别] 消息内容
```

示例：
```
[1234ms][DATA][INFO] Mode transition: MANUAL(1) → RANDOM(2)
[1235ms][LIGHT][INFO] Manual Mode Color: Pale Blue (RGB: 209,231,242)
[1236ms][TOF][DEBUG] Object detected at distance: 150cm
```

### 性能监控

- 任务执行时间跟踪
- 缓冲区状态监控
- 系统心跳（5秒间隔）
- 内存使用统计

---

## 实施指南

### 移动应用集成

#### 连接流程
1. 扫描设备（名称格式: `PRO-XXXX`）
2. 连接到GATT服务
3. 订阅通知特征
4. 发送初始配置

#### 命令发送示例 (JavaScript)
```javascript
// 切换到手动模式
sendCommand('1,999,999,999,999,999,999,50');

// 设置自定义颜色（节奏模式）
sendCommand('5,255,0,0,0,0,1,999'); // 红色

// 配置闪烁
sendCommand('100,4,999,999,999,999,999,999'); // 闪烁4次

// 紧急停止
sendCommand('13,999,999,999,999,999,999,999');
```

#### 通知处理
```javascript
onNotification(data) {
  switch(data) {
    case 'manual':
      // 手动模式触发
      break;
    case 'random':
      // 随机模式触发
      break;
    case 'rhythm':
      // 节奏模式触发
      break;
    case 'Timed Mode Overtimed':
      // 定时超时
      break;
  }
}
```

### 固件实现要点

1. **互斥锁使用**: 保护共享资源访问
2. **任务优先级**: 传感器任务 > 处理任务 > 灯光任务
3. **内存管理**: 避免动态分配，使用静态缓冲区
4. **看门狗**: 启用并定期喂狗

---

## 版本历史

| 版本 | 日期 | 主要变更 |
|------|------|---------|
| 0.0.1 | 2024-03-01 | 初始版本 |
| 0.0.2 | 2024-03-26 | 添加节奏模式和RGB控制 |

---

## 附录

### A. 常用命令快速参考

```
手动模式:     1,999,999,999,999,999,999,50
随机模式:     2,999,999,999,999,999,999,999
定时模式(5秒): 3,999,5000,999,999,999,999,999
双人模式:     4,999,999,999,999,999,0,999
红色节奏:     5,255,0,0,0,0,1,999
绿色节奏:     5,0,255,0,0,0,1,999
蓝色节奏:     5,0,0,255,0,0,1,999
开启模式:     11,999,999,999,999,999,999,999
关闭模式:     12,999,999,999,999,999,999,999
紧急停止:     13,999,999,999,999,999,999,999
配置(4次):    100,4,999,999,999,999,999,999
```

### B. RGB颜色预设

```
纯红:     RGB(255, 0, 0)
纯绿:     RGB(0, 255, 0)
纯蓝:     RGB(0, 0, 255)
黄色:     RGB(255, 255, 0)
青色:     RGB(0, 255, 255)
品红:     RGB(255, 0, 255)
白色:     RGB(255, 255, 255)
橙色:     RGB(255, 165, 0)
紫色:     RGB(128, 0, 128)
粉色:     RGB(255, 192, 203)
```

---

**文档状态**: ✅ 已完成
**维护负责人**: 开发团队
**联系方式**: [待填写]