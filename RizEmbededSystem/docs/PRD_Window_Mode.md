# Window Mode 产品需求文档 (PRD)

**版本:** 1.0.0
**创建日期:** 2025-12-06
**产品名称:** Riz反应灯训练系统 - Window Mode (窗口模式)
**模式代码:** 7 (WINDOW_MODE)

---

## 一、产品概述

### 1.1 功能定位

Window Mode（窗口模式）是一种高级反应训练模式，通过**时间窗口**机制训练用户的**时机判断能力**和**精准反应**。该模式结合了倒计时可视化和颜色反馈系统，只有在"最佳时间窗口"内触发传感器才算有效检测。

### 1.2 核心概念

- **总倒计时时长** (Total Window Duration): 从灯光亮起到完全熄灭的总时间
- **最佳窗口时长** (Good Window Duration): 绿色阶段的持续时间，只有在此时间段内检测才有效
- **两阶段颜色系统**: 橙色 → 绿色
  - **等待区** (Waiting Zone): 橙色 - 无效检测区，准备阶段
  - **最佳窗口区** (Good Window): 绿色 - 有效检测区，命中即成功

### 1.3 训练价值

- **时机判断训练**: 培养用户在最佳时刻做出反应的能力
- **精准控制**: 避免过早或过晚的反应
- **应用场景**:
  - 球类运动的击球时机
  - 格斗运动的进攻/防守时机
  - 认知训练中的冲动控制

---

## 二、功能详细设计

### 2.1 时间轴示例

以 **总时长 5秒、最佳窗口 3秒** 为例：

```
时间轴: 0s ──────────────────────> 5s
        │                         │
        ├─────┬─────────────────┤
        │橙色 │     绿色         │
        │2s   │      3s          │
        │     │                 │
     灯亮起  进入            灯熄灭
           最佳窗口
```

**时间分配算法:**
```
等待时长 = 总时长 - 最佳窗口时长
最佳窗口时长 = goodWindowDuration (参数)
```

**实际时间点:**
- `t=0s`: 灯光亮起，显示**橙色**（等待阶段开始）
- `t=2s`: 进入最佳窗口，颜色变为**绿色**（有效检测区开始）
- `t=5s`: 倒计时结束，灯光完全熄灭

### 2.2 颜色方案设计

| 阶段 | 颜色 | RGB值 | 含义 | 检测有效性 |
|------|------|-------|------|------------|
| **等待区** | 橙色 | (255, 140, 0) | "还没到时机，等待中..." | ❌ 无效 |
| **最佳窗口区** | 绿色 | (0, 255, 0) | "就是现在！" | ✅ 有效 |

**颜色过渡:**
- 橙→绿: **瞬间切换** (0-50ms)，清晰的视觉信号，标志最佳窗口开始
- 检测后或倒计时结束: **直接熄灭** (不返回橙色)

### 2.3 倒计时可视化 (双层同步熄灭)

**采用与 TIMED_MODE 相同的双层对称熄灭方式**:

- **LED总数**: 48颗 (LED_COUNT)
  - **第一层**: LED 0-23 (顺序熄灭)
  - **第二层**: LED 24-47 (逆序熄灭)
- **熄灭机制**: 基于时间比例计算当前应熄灭的LED数量
- **熄灭模式**:
  - 第一层从 LED 0 → LED 23 顺序熄灭
  - 第二层从 LED 47 → LED 24 逆序熄灭
  - 两层同步进行，形成对称的视觉效果
- **颜色变化**: 剩余LED保持当前阶段颜色（橙色或绿色）

**计算公式**:
```
已过时间 = 当前时间 - 开始时间
熄灭步数 = (已过时间 × 24) / 总时长
```

**示例** (5秒总时长，3秒最佳窗口):
```
时间进度计算:
- t=0s:    步数=0,  LED显示 [0-23橙色, 24-47橙色] (48个亮)
- t=1s:    步数=4.8, LED [5-23橙色, 24-42橙色] (38个亮)
- t=2s:    步数=9.6, LED [10-23绿色, 24-37绿色] (28个亮) ← 颜色变绿
- t=3.5s:  步数=16.8, LED [17-23绿色, 24-30绿色] (14个亮)
- t=5s:    步数=24,  全部熄灭 (0个亮)

熄灭顺序:
第一层: LED 0 → 1 → 2 → ... → 23 (从左到右)
第二层: LED 47 → 46 → 45 → ... → 24 (从右到左)
```

**非阻塞更新**:
- 在主循环中调用 `updateWindowAnimation()`
- 根据时间差计算目标步数
- 只有步数变化时才更新LED显示
- 不使用 `delay()`，保持系统响应性

### 2.4 传感器检测逻辑

**检测流程:**
1. 用户触发传感器 (TOF/MMWave)
2. 计算当前时间点: `currentTime = millis() - countdownStartTime`
3. 判断是否在最佳窗口内:
   - `waitingDuration = totalDuration - goodWindowDuration`
   - `goodWindowStart = waitingDuration`
   - `goodWindowEnd = totalDuration`

**判断结果:**
- **在最佳窗口内** (`currentTime >= goodWindowStart && currentTime <= goodWindowEnd`):
  - ✅ 有效检测（绿色阶段）
  - 发送回调: `"window"`
  - 激活蜂鸣器
  - 立即熄灭所有LED

- **在等待区** (`currentTime < goodWindowStart`):
  - ❌ 无效检测（橙色阶段）
  - 发送回调: `"window_miss"`
  - 短促蜂鸣提示错误
  - LED继续倒计时

### 2.5 回调消息设计

| 场景 | 回调消息 | 说明 |
|------|----------|------|
| 在绿色窗口内检测 | `"window"` | 成功反应，计入有效分数 |
| 在橙色等待区检测 | `"window_miss"` | 时机过早，不计分 |
| 倒计时结束未检测 | `"window_timeout"` | 超时，未做出反应 |

---

## 三、消息协议设计

### 3.1 参数映射方案

由于当前系统限制为**8个参数**，Window Mode 复用现有参数字段：

```
消息格式:
7,totalDuration,goodWindowDuration,buzzer,buzzerTime,sensorMode,placeholder1,placeholder2
```

### 3.2 参数详细说明

| 位置 | 参数名称 | 类型 | 说明 | 取值范围 | 默认值 |
|------|----------|------|------|----------|--------|
| 1 | `gameMode` | int | 游戏模式 | 7 (WINDOW_MODE) | - |
| 2 | `totalDuration` | int | 总倒计时时长 (ms) | 2000-10000 | 5000 |
| 3 | `goodWindowDuration` | int | 最佳窗口时长 (ms) | 1000-8000 | 3000 |
| 4 | `buzzer` | int | 蜂鸣器开关 | 0=关闭, 1=开启 | 1 |
| 5 | `buzzerTime` | int | 蜂鸣器时长 (ms) | 100-2000 | 500 |
| 6 | `sensorMode` | int | 传感器模式 | 0-3 (同RHYTHM) | 1 |
| 7 | `placeholder1` | int | 预留参数1 | - | 0 |
| 8 | `placeholder2` | int | 预留参数2 | - | 100 |

**传感器模式说明:**
- `0`: 无传感器 (仅倒计时展示，用于演示)
- `1`: 仅TOF传感器
- `2`: 仅MMWave传感器
- `3`: TOF + MMWave 双传感器

### 3.3 消息示例

**示例 1: 标准5秒窗口，3秒最佳时长**
```
7,5000,3000,1,500,1,0,100
```

**示例 2: 快速3秒窗口，1秒最佳时长**
```
7,3000,1000,1,300,1,0,100
```

**示例 3: 长时8秒窗口，5秒最佳时长，双传感器**
```
7,8000,5000,1,500,3,0,100
```

### 3.4 参数验证规则

**ESP32固件端验证:**
- `goodWindowDuration` 必须小于 `totalDuration`
- `totalDuration` 范围: 2000-10000ms
- `goodWindowDuration` 最小值: 1000ms
- 验证失败时拒绝消息并记录错误日志

**iOS应用端验证:**
- UI界面实时检查参数合法性
- 滑块联动：最佳窗口时长不能超过总时长
- 提供可视化时间轴预览

---

## 四、技术实现要点

### 4.1 ESP32固件实现关键点

**模块划分:**
1. **Global_VAR.h**: 定义 WINDOW_MODE 常量和颜色RGB值
2. **DataControl.cpp**:
   - 解析Window Mode消息
   - 验证参数合法性
   - 存储参数（复用现有字段）
3. **LightControl.cpp**:
   - 实现 `windowWipe()` 函数：初始化动画状态
   - 实现 `initWindowAnimation()` 函数：设置动画参数
   - 实现 `updateWindowAnimation()` 函数：非阻塞更新LED（参考 TIMED_MODE）
   - 实现 `abortWindowAnimation()` 函数：中止动画
   - 实现两阶段颜色切换逻辑
4. **main.cpp**:
   - 在主循环中调用 `LIGHT.update()` 更新动画
   - 检测传感器触发
   - 判断是否在最佳窗口内
   - 发送对应回调消息

**数据存储策略:**
- 复用 `timedBreak` 字段存储总时长
- 复用 `blinkBreak` 字段存储最佳窗口时长
- 复用 `sensorMode` 字段存储传感器模式

**动画实现策略（参考 TIMED_MODE）:**
- 使用 `WindowAnimationState` 结构体存储动画状态
  - `isRunning`: 动画是否运行中
  - `startTime`: 动画开始时间戳
  - `duration`: 总时长
  - `currentStep`: 当前熄灭步数 (0-24)
  - `totalSteps`: 总步数 (24)
  - `orangeColor[3]`: 橙色RGB值
  - `greenColor[3]`: 绿色RGB值
  - `goodWindowStart`: 最佳窗口开始时间（毫秒）
- 非阻塞更新：每次循环计算目标步数，只在步数变化时更新LED
- 颜色切换：根据 `elapsedTime >= goodWindowStart` 判断使用橙色或绿色

**性能要求:**
- 颜色切换延迟 < 50ms
- 检测判断延迟 < 100ms
- LED更新响应性：无阻塞，实时计算
- 时间精度：基于 `millis()` 的绝对时间戳

### 4.2 iOS应用实现关键点

**模块划分:**
1. **Config.swift**: 添加 `windowMode = 7` 常量
2. **Game.swift**:
   - 添加 Window Mode 专用数据字段
   - 实现 getters/setters
3. **DM_Game_Helper.swift**:
   - 实现 `genWindowModeMessage()` 函数
   - 参数验证和格式化
4. **DM_Game_Handler.swift**:
   - 处理三种回调: `window`, `window_miss`, `window_timeout`
   - 更新统计数据
5. **UI界面**:
   - 参数设置滑块（总时长、窗口时长）
   - 时间轴可视化预览
   - 传感器模式选择器

**用户体验设计:**
- 提供直观的时间轴预览组件
- 滑块联动验证
- 清晰的反馈提示

---

## 五、用户交互流程

### 5.1 游戏启动流程

```
1. 用户在iOS应用中选择 Window Mode
2. 设置参数:
   - 总时长: 5000ms (滑块调节)
   - 最佳窗口: 3000ms (滑块调节)
   - 传感器模式: TOF (选择器)
3. 点击"开始训练"
4. iOS发送消息: "7,5000,3000,1,500,1,0,100"
5. ESP32设备收到消息:
   - 解析参数
   - 验证有效性
   - 启动倒计时
6. LED亮起橙色，开始倒计时
```

### 5.2 训练过程流程图

```
开始倒计时
    ↓
[0-2秒] 橙色LED逐渐熄灭 (等待阶段)
    │
    │ ← 用户此时触发 → "window_miss" (太早了！)
    │                   → 短促错误音
    │                   → LED继续倒计时
    ↓
[2秒] 颜色切换为绿色 (最佳窗口开始)
    ↓
[2-5秒] 绿色LED逐渐熄灭 ← ✅ 最佳检测区
    │
    │ ← 用户此时触发 → "window" (成功!)
    │                   → 蜂鸣器响
    │                   → LED全部熄灭
    │                   → 计分+1
    ↓
[5秒] 倒计时结束
    │
    │ ← 未检测 → "window_timeout"
    ↓
进入下一轮
```

### 5.3 反馈机制

| 用户行为 | LED反馈 | 蜂鸣器 | 回调消息 | iOS界面显示 |
|----------|---------|--------|----------|-------------|
| 在橙色等待区触发 | 继续倒计时 | 短促"哔"(100ms) | `window_miss` | "太早了！等绿灯" |
| 在绿色窗口触发 | 立即全熄灭 | 成功音效(500ms) | `window` | "完美反应！+1" |
| 超时未触发 | 自然熄灭 | 无 | `window_timeout` | "超时错过" |

---

## 六、数据统计与分析

### 6.1 统计指标

| 指标 | 说明 | 计算公式 |
|------|------|----------|
| **命中率** | 在最佳窗口内成功检测的比例 | `window次数 / (window + window_miss + timeout)` |
| **平均反应时间** | 从进入绿色窗口到检测的时间 | `Σ(检测时间 - 窗口开始时间) / window次数` |
| **最佳时机点** | 最常触发的时间点 | 统计检测时间的分布峰值 |
| **过早触发率** | 在橙色阶段误触发的比例 | `window_miss次数 / 总尝试次数` |

### 6.2 iOS端数据存储结构

**WindowModeStatistics 数据模型:**
- `totalAttempts`: 总尝试次数
- `successHits`: 成功命中数 (绿色窗口内检测)
- `earlyMisses`: 过早触发数 (橙色等待区检测)
- `timeouts`: 超时未触发数
- `reactionTimes`: 反应时间数组 (ms)
- `hitRate`: 命中率 (计算属性)
- `averageReactionTime`: 平均反应时间 (计算属性)

---

## 七、高级功能扩展

### 7.1 难度等级预设

| 难度 | 总时长 | 最佳窗口 | 窗口比例 | 目标用户 |
|------|--------|----------|----------|----------|
| **初级** | 6000ms | 4000ms | 66.7% | 初学者 |
| **中级** | 5000ms | 3000ms | 60% | 进阶用户 |
| **高级** | 4000ms | 2000ms | 50% | 熟练用户 |
| **专家** | 3000ms | 1000ms | 33.3% | 专业运动员 |
| **大师** | 2000ms | 500ms | 25% | 极限挑战 |

### 7.2 动态难度调整

**调整策略:**
- 命中率 > 80% → 缩小窗口 500ms (增加难度)
- 命中率 < 40% → 扩大窗口 500ms (降低难度)
- 根据用户表现自动优化训练难度

### 7.3 多设备协同训练

**场景**: 2-4个设备同时进行 Window Mode

```
设备1: 总5s, 窗口3s, 延迟0s   → 橙-绿-橙 (立即开始)
设备2: 总5s, 窗口3s, 延迟2s   → 2秒后启动
设备3: 总5s, 窗口3s, 延迟4s   → 4秒后启动
设备4: 总5s, 窗口3s, 延迟6s   → 6秒后启动

训练效果: 连续反应训练，培养节奏感
```

---

## 八、测试用例

### 8.1 功能测试

| 测试ID | 测试场景 | 输入参数 | 预期结果 |
|--------|----------|----------|----------|
| WT-001 | 标准窗口检测 | 总5s, 窗口3s, 在3.5s触发 | 发送 `window`, LED熄灭 |
| WT-002 | 等待区误触发 | 总5s, 窗口3s, 在0.5s触发 | 发送 `window_miss`, 短促蜂鸣 |
| WT-003 | 窗口开始边界 | 总5s, 窗口3s, 在2.0s触发 | 发送 `window`, LED熄灭 |
| WT-004 | 窗口结束边界 | 总5s, 窗口3s, 在5.0s触发 | 发送 `window`, LED熄灭 |
| WT-005 | 超时未检测 | 总5s, 窗口3s, 无触发 | 5s后发送 `window_timeout` |
| WT-006 | 参数验证 | 窗口3s > 总2s | 拒绝消息，记录错误日志 |
| WT-007 | 颜色切换 | 总5s, 窗口3s | 0-2s橙, 2-5s绿 |
| WT-008 | 倒计时可视化 | 总5s, 48个LED | 双层对称熄灭，步数随时间线性增长 |
| WT-009 | 颜色动态切换 | 总5s, 窗口3s | 0-2s显示橙色，2-5s显示绿色 |

### 8.2 边界条件测试

| 测试ID | 边界条件 | 输入 | 预期行为 |
|--------|----------|------|----------|
| WB-001 | 最小总时长 | 总2000ms, 窗口1000ms | 正常运行 |
| WB-002 | 最大总时长 | 总10000ms, 窗口8000ms | 正常运行 |
| WB-003 | 窗口=总时长 | 总5000ms, 窗口5000ms | 拒绝，记录错误 |
| WB-004 | 窗口>总时长 | 总3000ms, 窗口5000ms | 拒绝，记录错误 |
| WB-005 | 极限窗口开始 | 总5000ms, 窗口4999ms | 0-0.5ms橙, 0.5-4999.5ms绿 |
| WB-006 | 零传感器模式 | sensorMode=0 | 仅展示倒计时，不检测 |
| WB-007 | 双传感器模式 | sensorMode=3 | TOF或MMWave任一触发都有效 |

### 8.3 性能测试

| 测试项 | 指标 | 目标值 |
|--------|------|--------|
| 颜色切换延迟 | 橙→绿的响应时间 | < 50ms |
| 检测判断延迟 | 从传感器触发到回调发送 | < 100ms |
| LED更新响应性 | 主循环无阻塞，实时计算 | 无 delay() 调用 |
| 时间精度 | 倒计时与实际时间的偏差 | < 100ms |
| 内存占用 | WindowAnimationState 结构体 | < 100 bytes |

---

## 九、风险评估与缓解措施

### 9.1 技术风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| **颜色切换不同步** | 用户看到绿色但判断为橙色 | 中 | 使用原子操作更新颜色状态，确保颜色与时间戳同步 |
| **边界时间判断** | 2.0秒恰好触发时判断不一致 | 中 | 使用 >= 判断窗口开始，明确边界归属 |
| **传感器误触发** | 等待区检测被误判为有效 | 低 | 双重检查时间戳，添加debounce |
| **倒计时漂移** | 长时间运行后时间不准 | 低 | 使用millis()绝对时间而非累加 |
| **参数验证不足** | 无效参数导致设备崩溃 | 中 | 严格验证，拒绝无效消息 |

### 9.2 用户体验风险

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| **难度过高** | 用户挫败感强 | 提供预设难度，从初级开始 |
| **反馈不明确** | 用户不知道是否成功 | 不同音效+LED反馈+iOS界面提示 |
| **参数设置复杂** | 用户不会配置 | 提供可视化时间轴预览 |

---

## 十、开发计划

### 10.1 实施阶段

| 阶段 | 工作内容 | 工时估算 | 负责人 |
|------|----------|----------|--------|
| **Phase 1** | ESP32固件基础实现 | 4小时 | 固件开发 |
| - | Global_VAR.h 定义 | 0.5h | - |
| - | DataControl.cpp 解析 | 1h | - |
| - | LightControl.cpp windowWipe() | 1.5h | - |
| - | main.cpp 检测逻辑 | 1h | - |
| **Phase 2** | iOS应用基础实现 | 6小时 | iOS开发 |
| - | 数据模型扩展 | 1h | - |
| - | 消息生成函数 | 1h | - |
| - | 回调处理逻辑 | 1h | - |
| - | UI界面开发 | 3h | - |
| **Phase 3** | 倒计时可视化优化 | 3小时 | 固件开发 |
| - | 颜色过渡优化 | 1h | - |
| - | LED更新性能优化 | 1h | - |
| - | 时间精度调优 | 1h | - |
| **Phase 4** | 测试与修复 | 4小时 | QA |
| - | 功能测试 | 2h | - |
| - | 边界条件测试 | 1h | - |
| - | Bug修复 | 1h | - |
| **Phase 5** | 数据统计功能 | 3小时 | iOS开发 |
| - | 统计模型设计 | 1h | - |
| - | 数据可视化 | 2h | - |

**总计: 20小时 (约2.5工作日)**

### 10.2 里程碑

- **M1 (Day 1)**: ESP32固件基本功能完成，可接收消息并显示倒计时
- **M2 (Day 2)**: iOS应用可发送Window Mode消息，接收回调
- **M3 (Day 2.5)**: 完整功能测试通过
- **M4 (Day 3)**: 数据统计功能上线，正式发布

---

## 十一、成功标准

### 11.1 功能完整性

- ✅ 能正确解析8参数消息格式
- ✅ 三阶段颜色切换准确 (橙-绿-橙)
- ✅ 饼状倒计时可视化流畅
- ✅ 最佳窗口内检测100%准确
- ✅ 窗口外检测正确拒绝并反馈

### 11.2 性能指标

- ✅ 颜色切换延迟 < 50ms
- ✅ 检测判断延迟 < 100ms
- ✅ LED刷新率 ≥ 30 FPS
- ✅ 无内存泄漏，运行稳定

### 11.3 用户体验

- ✅ 用户能理解时间窗口概念
- ✅ 反馈清晰明确（音效+视觉+数据）
- ✅ 参数设置简单直观
- ✅ 能看到进步趋势（统计图表）

---

## 十二、附录

### 12.1 相关模式对比

| 特性 | TIMED_MODE | RHYTHM_MODE | WINDOW_MODE |
|------|------------|-------------|-------------|
| **核心机制** | 超时检测 | 自定义倒计时 | 时间窗口判断 |
| **颜色变化** | 单色 | 自定义单色 | **两阶段颜色 (橙→绿)** |
| **有效性判断** | 超时前任意时刻 | 倒计时期间任意时刻 | **仅绿色窗口内** |
| **训练目标** | 速度 | 节奏感 | **时机判断精准度** |
| **难度调节** | 超时时长 | 倒计时时长 | **窗口大小比例** |

### 12.2 技术参考

**关键参考实现:**
- **LED 双层熄灭动画**: `src/LightControl.cpp` 中的 TIMED_MODE 实现
  - `timedWipe()`: 初始化动画 (line 665-689)
  - `initTimedAnimation()`: 设置动画参数 (line 770-784)
  - `updateTimedAnimation()`: 非阻塞更新逻辑 (line 790-830)
  - 双层对称熄灭算法 (line 816-823)
- **颜色切换逻辑**: RHYTHM_MODE 中的颜色管理
- **消息解析框架**: `src/DataControl.cpp` 中的 updateMsg() 函数
- **iOS消息生成**: `DM_Game_Helper.swift` 中的 genMessage() 函数

**Window Mode 特殊之处:**
- 需要在动画过程中根据时间切换颜色（橙→绿）
- TIMED_MODE 只有单一颜色，Window Mode 需要两阶段颜色
- 需要在 `updateWindowAnimation()` 中判断当前时间段并设置对应颜色

### 12.3 文件位置参考

**ESP32固件:**
- `include/Global_VAR.h`: 常量定义
- `src/DataControl.cpp`: 消息解析
- `src/LightControl.cpp`: LED控制
- `src/main.cpp`: 主循环逻辑

**iOS应用:**
- `Model/Config.swift`: 常量定义
- `Model/Game.swift`: 数据模型
- `ViewModel/DM_Game_Helper.swift`: 消息生成
- `ViewModel/DM_Game_Handler.swift`: 回调处理
- `View/`: UI界面组件

### 12.4 术语表

| 术语 | 英文 | 说明 |
|------|------|------|
| 总倒计时时长 | Total Window Duration | 从灯光亮起到完全熄灭的总时间 |
| 最佳窗口时长 | Good Window Duration | 绿色阶段的持续时间，有效检测区 |
| 等待区 | Waiting Zone | 倒计时开始的橙色阶段，准备区域 |
| 两阶段颜色 | Two-Phase Color | 橙色(等待) → 绿色(有效窗口) |
| 双层对称熄灭 | Dual-Layer Symmetric Fade | 第一层顺序熄灭、第二层逆序熄灭的LED动画 |
| 非阻塞动画 | Non-blocking Animation | 不使用delay()，基于时间戳计算的实时更新 |

---

**文档结束**

**版本:** 1.0.0
**作者:** Claude (AI Assistant)
**审核状态:** 待审核
**下次更新:** 实施后根据测试结果修订
