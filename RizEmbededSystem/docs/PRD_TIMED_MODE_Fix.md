# TIMED 模式功能修复 - 产品需求文档

## 1. 问题概述

### 当前问题
在 TIMED 模式下存在以下三个主要问题：

1. **LED 动画被中断**
   - TIMED 模式配置的 5 秒倒计时动画经常被提前发送的 TERMINATE 命令打断
   - 导致 LED 无法完整展示预期的渐灭动画效果
   - 用户无法看到完整的视觉反馈

2. **缺少倒计时显示**
   - 当前 TIMED 模式没有独立的倒计时计时器显示
   - LED 渐灭过程只是作为隐性的倒计时动画
   - 用户体验不清晰，缺少明确的时间反馈

3. **传感器检测未激活**
   - TIMED 模式下 TOF 传感器检测功能被注释掉（main.cpp 第 409 行）
   - 无法在倒计时过程中检测用户交互
   - 限制了游戏交互功能

## 2. 根本原因分析

### 代码流程问题

**当前流程：**
```
T=0s   → 收到 TIMED 模式命令
T=0s   → 进入 timedWipe() 函数
T=0-5s → LED 逐个渐灭（使用阻塞式 delay()）
T<5s   → 如果收到 TERMINATE → 立即 turnLightOff() 中断
```

**问题根源：**
1. 动画使用阻塞式 `delay()`，无法立即响应外部命令
2. TERMINATE 处理没有检查当前动画状态
3. 缺少非阻塞计时机制
4. 没有倒计时数据的实时显示

## 3. 需求定义

### 3.1 功能需求

#### F1: 完整的 LED 倒计时动画显示
- **描述**：TIMED 模式启动时，LED 应该完整地展示 5 秒的渐灭动画
- **行为**：
  - 收到 TIMED 命令后，所有 LED 点亮指定颜色
  - 按照配置的 timedBreak 时长逐个 LED 渐灭
  - 动画不应被提前的 TERMINATE 命令中断（除非特别设计）
- **优先级**：高
- **验收标准**：
  - LED 动画完整展示 100% 的像素
  - 动画执行时间符合 timedBreak 配置
  - 视觉效果流畅，无卡顿

#### F2: 实时倒计时计时器显示
- **描述**：在 TIMED 模式运行过程中，实时显示剩余倒计时时间
- **行为**：
  - 倒计时数据应该通过 BLE 发送给移动端显示
  - 显示格式：剩余时间（毫秒或秒）
  - 更新频率：建议每 100-500ms 更新一次
  - 动画完成时发送完成信号
- **优先级**：高
- **验收标准**：
  - 移动端能实时显示倒计时进度
  - 时间显示准确性误差 < 100ms
  - 用户能清晰了解剩余时间

#### F3: TIMED 模式传感器激活
- **描述**：在 TIMED 模式下激活 TOF 传感器，实现游戏交互功能
- **行为**：
  - TIMED 模式启动时，激活 TOF 传感器检测
  - 如果在倒计时期间检测到物体，触发相应的反应
  - 传感器应在动画完成或 TERMINATE 时停止
- **优先级**：中
- **验收标准**：
  - TOF 传感器在 TIMED 模式下正常工作
  - 检测延迟 < 50ms
  - 支持在倒计时过程中的物体检测

#### F4: 非阻塞式动画执行
- **描述**：改进 LED 动画执行机制，使其不阻塞其他任务
- **行为**：
  - 使用非阻塞计时机制替代 `delay()` 阻塞
  - 动画状态在 update() 函数中更新
  - 允许在动画执行期间处理其他命令
- **优先级**：高
- **验收标准**：
  - 动画执行期间系统仍响应 BLE 命令
  - 无明显的卡顿或延迟
  - CPU 占用率正常

#### F5: 优雅的命令中断机制
- **描述**：TERMINATE 命令能够优雅地中断 TIMED 模式动画
- **行为**：
  - 收到 TERMINATE 时，立即停止动画
  - 清除所有 LED
  - 停止传感器检测
  - 记录中断时的状态日志
- **优先级**：中
- **验收标准**：
  - TERMINATE 命令响应时间 < 10ms
  - LED 在收到命令后 100ms 内完全熄灭
  - 传感器正确停止

## 4. 架构设计

### 4.1 动画状态管理

**引入动画状态结构：**
```
AnimationState {
  isRunning: bool              // 动画是否运行
  startTime: unsigned long     // 动画开始时间戳
  duration: unsigned long      // 总时长（毫秒）
  currentStep: int             // 当前 LED 步数
  totalSteps: int              // 总步数（LED 数量）
  lastUpdateTime: unsigned long // 上次更新时间
}
```

**状态转移：**
- IDLE → RUNNING（收到 TIMED 命令）
- RUNNING → COMPLETED（动画完成）
- RUNNING → INTERRUPTED（收到 TERMINATE）

### 4.2 计时机制改进

**当前方案（有问题）：**
- 使用阻塞式 `delay()`
- 顺序执行每个 LED 的渐灭
- 无法并发处理其他任务

**改进方案：**
- 使用非阻塞计时（`millis()` 时间戳比较）
- 在 `update()` 函数中按时间比例计算当前进度
- 支持平滑的进度更新

### 4.3 BLE 实时反馈

**新增 BLE 消息格式：**
```
timed_progress: "timed_countdown:<remaining_ms>"
示例：
  "timed_countdown:4500"  // 剩余 4.5 秒
  "timed_countdown:3000"  // 剩余 3 秒
  "timed_countdown:0"     // 倒计时完成
```

**消息发送策略：**
- 定期发送进度信息（每 500ms）
- 当 LED 完成时发送完成信号
- 当接收到 TERMINATE 时发送中断信号

## 5. 技术方案

### 5.1 代码改进方向

#### 区域 1：LightControl 类改进
- 为 timedWipe() 添加非阻塞执行支持
- 维护动画进度状态变量
- 在 update() 函数中处理动画更新逻辑
- 支持动画中止（abort）功能

#### 区域 2：ProcessingTask 改进
- 检查 TIMED_MODE 时激活 TOF 传感器
- 为 TIMED_MODE 添加倒计时计时器逻辑
- 每个周期计算并发送进度到 BLE
- 正确处理动画完成和中断转移

#### 区域 3：主循环优化
- 确保 ProcessingTask 能够快速响应模式变化
- 提高动画更新频率（目前 10ms，可保持）
- 确保 BLE 消息发送不阻塞主循环

#### 区域 4：BluetoothControl 改进
- 支持发送倒计时进度消息
- 添加动画中断确认机制

### 5.2 关键改进点

1. **动画非阻塞化**
   - 用时间戳替代 delay()
   - 根据经过时间计算 LED 点亮位置
   - 在每个 update() 周期增量更新

2. **传感器激活**
   - 在 TIMED_MODE 检查时激活 TOF
   - 设置合适的检测敏感度
   - 在动画完成时停止检测

3. **实时反馈**
   - 计算剩余倒计时时间
   - 定期发送进度给移动端
   - 提供用户友好的视觉反馈

4. **中断处理**
   - TERMINATE 时立即停止动画
   - 清除所有状态
   - 关闭传感器和 BLE 反馈

## 6. 测试验收标准

### 6.1 功能测试

| 测试项 | 预期结果 | 验收标准 |
|--------|---------|---------|
| LED 完整动画显示 | 所有 48 个 LED 逐个渐灭 | 无断裂，流畅 |
| 倒计时准确性 | 倒计时与实际时间同步 | 误差 < 100ms |
| 传感器检测 | 在倒计时期间能检测物体 | 响应 < 50ms |
| TERMINATE 中断 | 立即停止并熄灭 LED | 响应 < 10ms |
| BLE 反馈 | 接收实时进度信息 | 每 500ms 更新 |

### 6.2 性能测试

| 指标 | 目标值 |
|------|-------|
| 动画帧率 | > 30fps |
| CPU 占用 | < 30% |
| 内存泄漏 | 无 |
| 响应延迟 | < 10ms |

### 6.3 兼容性测试

- 与其他游戏模式切换
- 与 RHYTHM_MODE 兼容
- 与 MANUAL_MODE 兼容
- 与 TERMINATE 模式兼容

## 7. 实现优先级

### Phase 1（高优先级 - P0）
- 实现非阻塞式 LED 动画
- 修复 TERMINATE 中断问题
- 确保动画完整显示

### Phase 2（中优先级 - P1）
- 激活 TOF 传感器检测
- 实现 BLE 倒计时反馈
- 优化用户体验

### Phase 3（低优先级 - P2）
- 性能优化
- 额外的交互功能
- 日志和调试完善

## 8. 风险与缓解

| 风险 | 影响 | 缓解方案 |
|------|------|---------|
| 动画帧率下降 | 视觉卡顿 | 优化计时精度，监测 CPU 占用 |
| 内存不足 | 系统崩溃 | 定期检查内存使用，避免内存泄漏 |
| 传感器误触发 | 游戏体验差 | 调整敏感度阈值，添加防抖 |
| BLE 消息丢失 | 进度显示不同步 | 添加消息确认机制 |

## 9. 成功标准

✅ TIMED 模式下 LED 动画完整展示，无中断
✅ 实时倒计时信息发送到移动端
✅ TOF 传感器在倒计时期间正常工作
✅ TERMINATE 命令能立即中断动画
✅ 系统响应流畅，无卡顿
✅ 所有测试用例通过

## 10. 后续跟踪

- 完成编码后进行完整功能测试
- 收集用户反馈优化交互设计
- 考虑将该方案推广到其他游戏模式
