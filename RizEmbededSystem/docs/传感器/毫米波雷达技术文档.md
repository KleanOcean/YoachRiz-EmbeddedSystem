# 毫米波雷达模块技术文档

## 1. 模块概述

### 1.1 硬件规格
- **型号**: ME73MS01 24GHz毫米波雷达模块
- **工作频率**: 24GHz ISM频段
- **通信接口**: UART串口（115200波特率，8N1）
- **供电电压**: 5V
- **检测范围**: 10-150厘米
- **应用场景**: 运动检测、存在感知、微动检测

### 1.2 引脚配置
| 引脚功能 | ESP32引脚 | 说明 |
|---------|----------|------|
| RX | GPIO 14 | 接收雷达TX数据 |
| TX | GPIO 21 | 发送指令到雷达RX |
| VCC | 5V | 电源正极 |
| GND | GND | 电源地 |

### 1.3 当前状态
毫米波雷达模块在代码中**已完整实现但处于禁用状态**。要启用该功能，需要取消相关代码注释。

---

## 2. 数据帧格式

### 2.1 帧结构（18字节）

| 字节索引 | 字段名称 | 描述 |
|---------|---------|------|
| 0-1 | 帧头 | 0x55 0xA5（同步字节） |
| 2-7 | 命令/长度 | 帧元数据 |
| 8 | 存在标志 | 0=无目标，1=运动，2=静止存在 |
| 9-10 | 距离值 | 16位距离（厘米，大端序） |
| 11-14 | 保留 | 未使用 |
| 15-16 | 信号强度 | 16位信号强度值（大端序） |
| 17 | 校验和 | 字节0-16的和（模256） |

### 2.2 存在状态定义

- **NO_TARGET (0)**: 无检测目标
- **MOTION (1)**: 检测到运动物体
- **PRESENCE (2)**: 检测到静止物体（通过微动感知）

---

## 3. 检测参数配置

### 3.1 默认参数设置

| 参数名称 | 默认值 | 说明 |
|---------|-------|------|
| 信号强度阈值 | 150 | 最小信号强度要求（从400降低以提高灵敏度） |
| 最大检测距离 | 200厘米 | 有效检测范围上限 |
| 延迟时间 | 100毫秒 | 触发延迟参数 |

### 3.2 有效检测范围
- **最小距离**: 10厘米
- **最大距离**: 150厘米
- **有效范围验证**: 距离必须在10-150厘米之间

---

## 4. 检测算法

### 4.1 双阈值检测机制

系统采用智能双阈值检测算法，包含两种触发条件：

**条件1：即时检测（强信号）**
- 信号强度 ≥ 150
- 距离在10-150厘米范围内
- 存在标志非零
- 满足条件立即触发

**条件2：延迟检测（弱信号）**
- 连续3帧检测到运动
- 信号强度 ≥ 105（阈值的70%）
- 距离在有效范围内
- 存在标志非零

这种双重机制的优势：
- 强信号立即响应，保证灵敏度
- 弱信号需要多帧确认，减少误触发
- 平衡了检测速度和准确性

### 4.2 检测流程

```
1. 读取UART数据帧
   ↓
2. 验证帧头(0x55 0xA5)和校验和
   ↓
3. 解析距离、信号强度、存在标志
   ↓
4. 应用双阈值检测逻辑
   ↓
5. 更新检测状态
   ↓
6. 触发相应游戏模式动作
```

---

## 5. 系统集成

### 5.1 FreeRTOS任务架构

**MMWaveSensorTask任务特性**：
- 运行核心：Core 1
- 优先级：2
- 栈大小：4096字节
- 功能：持续监控雷达数据并更新检测状态

### 5.2 任务生命周期

1. **初始化阶段**: 配置UART，验证连接
2. **启动检测**: 创建检测任务，清空缓冲区
3. **持续监控**: 高优先级读取UART数据
4. **检测触发**: 满足条件时设置检测标志
5. **停止检测**: 终止任务，清理资源

### 5.3 缓冲区管理策略

- **启动前清空**: 检测开始前彻底清空串口缓冲区
- **紧急排空**: 缓冲区超过200字节时强制清空
- **同步恢复**: 自动搜索帧头(0x55 0xA5)重新同步
- **缓冲区大小**: 1024字节UART接收缓冲区

---

## 6. 游戏模式集成

### 6.1 支持的游戏模式

**节奏模式（RHYTHM_MODE，模式5）**

传感器模式参数（sensorMode）控制：
- `0`: 不使用传感器
- `1`: 仅使用TOF激光雷达
- `2`: **仅使用毫米波雷达**
- `3`: **同时使用两种传感器**

**定时模式（TIMED_MODE，模式3）**
- 可配置使用毫米波雷达进行定时检测
- 检测到物体时立即关闭灯光

### 6.2 检测响应动作

当检测到范围内物体时：
1. 立即停止LED灯光
2. 停止雷达检测任务
3. 记录检测事件日志
4. 触发对应模式的游戏逻辑

---

## 7. 控制接口

### 7.1 主要控制方法

| 方法名称 | 功能说明 |
|---------|---------|
| `init()` | 初始化传感器，验证连接 |
| `begin()` | 配置UART并运行连接测试 |
| `startDetection()` | 创建检测任务，开始监控 |
| `stopDetection()` | 终止检测任务 |
| `isObjectInRange()` | 查询是否有物体在范围内 |
| `getTargetDistance()` | 获取最近测量距离（厘米） |
| `getSignalStrength()` | 获取信号强度值 |

### 7.2 参数配置方法

| 方法名称 | 功能说明 | 参数范围 |
|---------|---------|---------|
| `setExpectedSignalStrength()` | 设置信号强度阈值 | 50-500 |
| `setExpectedDistance()` | 设置最大检测距离 | 10-600厘米 |

---

## 8. 数据存储结构

### 8.1 DataControl集成

毫米波参数在DataControl类中存储：

| 参数名称 | 默认值 | 说明 |
|---------|-------|------|
| mmWaveStrength | 200 | 信号强度阈值 |
| mmWaveDistance | 20 | 检测距离设置 |
| mmWaveDelay | 0 | 延迟参数 |

### 8.2 参数矩阵

系统使用简单的参数配置，而非复杂的矩阵结构：
- 单一距离阈值判断
- 单一信号强度阈值
- 无预定义的检测区域门限矩阵

---

## 9. 诊断与调试

### 9.1 连接诊断功能

`checkConnections()`方法提供全面的硬件诊断：
1. TX引脚连续性测试
2. RX引脚上拉测试
3. UART通信测试
4. 连接状态日志记录

### 9.2 日志系统

**日志级别**：
- INFO：正常运行信息
- WARNING：潜在问题
- ERROR：错误和异常

**关键日志信息**：
- 心跳日志（每秒）：帧计数、空循环、同步错误
- 检测事件：信号强度、距离、存在状态
- 缓冲区状态：可用字节数、同步状态
- 状态变化：启动/停止事件、物体检测

**日志格式示例**：
```
[INFO][MMWAVE] SENSOR: P:MOTION|SS:180(150)|TD:85|MF:1|InRange:0->1|Bytes:12
```

解释：
- P: 存在状态（MOTION）
- SS: 信号强度180（阈值150）
- TD: 目标距离85厘米
- MF: 连续运动帧数1
- InRange: 检测状态从0变为1
- Bytes: 缓冲区12字节

---

## 10. 性能优化

### 10.1 缓冲区优化策略

**问题与解决方案**：
- **问题**：串口数据积累导致延迟
- **方案**：检测前彻底清空缓冲区

- **问题**：数据帧同步丢失
- **方案**：自动搜索帧头恢复同步

- **问题**：缓冲区溢出
- **方案**：200字节紧急排空机制

### 10.2 任务安全机制

1. **任务挂起后删除**：确保任务安全终止
2. **互斥锁保护**：共享状态的线程安全
3. **优雅关闭**：资源清理和状态重置

### 10.3 检测优化

- **快速响应**：强信号立即检测
- **抗干扰**：弱信号多帧确认
- **自适应**：70%阈值的弱信号检测

---

## 11. 使用建议

### 11.1 硬件连接注意事项

1. **电源稳定性**：确保5V电源稳定，避免电压波动
2. **接地共用**：雷达模块与ESP32共地
3. **信号电平**：注意3.3V/5V电平转换
4. **线缆长度**：UART连接线不宜过长（<30cm）

### 11.2 参数调优指南

**提高灵敏度**：
- 降低信号强度阈值（如从150降至100）
- 增加检测距离范围
- 减少连续帧要求

**减少误触发**：
- 提高信号强度阈值
- 增加连续帧数要求
- 缩小有效距离范围

### 11.3 典型应用场景配置

**近距离高灵敏度**（如手势检测）：
- 距离：10-50厘米
- 信号阈值：100
- 连续帧：2

**中距离平衡配置**（默认）：
- 距离：10-150厘米
- 信号阈值：150
- 连续帧：3

**远距离低误触发**（如入侵检测）：
- 距离：50-200厘米
- 信号阈值：200
- 连续帧：5

---

## 12. 故障排除

### 12.1 常见问题

**无法检测到物体**：
- 检查硬件连接
- 验证电源电压
- 确认代码未被注释
- 调整信号强度阈值

**频繁误触发**：
- 提高信号强度阈值
- 增加连续帧要求
- 检查环境干扰源

**数据帧同步失败**：
- 检查波特率设置
- 验证TX/RX连接
- 清空串口缓冲区

### 12.2 启用模块步骤

1. 取消`Global_VAR.h`中引脚定义注释（103-105行）
2. 取消`main.cpp`中相关代码注释：
   - 第7行：包含头文件
   - 第68行：创建对象
   - 第74行：互斥锁
   - 第554行：任务创建
3. 重新编译上传固件
4. 验证串口日志输出

---

## 13. 技术规范总结

| 项目 | 规格 |
|------|------|
| 检测技术 | 24GHz FMCW雷达 |
| 最大检测距离 | 6米（软件限制150厘米） |
| 距离分辨率 | 1厘米 |
| 角度覆盖 | 水平60°，垂直30° |
| 数据更新率 | 约10Hz |
| 功耗 | <2W |
| 工作温度 | -20°C至60°C |

---

## 14. 版本历史

- **v1.0**: 初始实现，基础检测功能
- **v1.1**: 添加双阈值检测算法
- **v1.2**: 优化缓冲区管理
- **v1.3**: 降低信号阈值提高灵敏度（当前版本）

---

**文档维护**: Yoach开发团队
**最后更新**: 2024-11-23
**文档状态**: 完整实现，当前禁用