# OTA GUI 更新系统

**文档版本**: v1.0.0
**文档类型**: ORG 文档（Organization-level Module Introduction）
**创建日期**: 2025-11-23
**最后更新**: 2025-11-23
**文档作者**: Klean
**目标读者**: 产品团队、开发团队、测试团队

**文档目的**: 本文档用于对齐全团队对 OTA GUI 更新系统的理解，
定义"OTA GUI 更新系统是什么"，为后续编写详细 PRD 文档提供基础。

---

## 📑 目录

- [1. 模块定义](#1-模块定义)
- [2. 核心设计原则](#2-核心设计原则)
- [3. 模块结构与组成](#3-模块结构与组成)
- [4. 用户体验流程](#4-用户体验流程)
- [5. 模块定位与关系](#5-模块定位与关系)
- [附录 A: 版本历史](#附录-a-版本历史)

---

## 1. 模块定义

### 1.1 一句话定义

> OTA GUI 更新系统是一个跨平台桌面应用程序，用于编译固件、搜索设备、建立连接并通过蓝牙向 Riz 设备推送固件更新。

### 1.2 核心特征

| 特征 | 说明 | 独特价值 |
|------|------|----------|
| **一键编译** | 自动调用 PlatformIO 编译最新固件 | 无需命令行操作 |
| **设备发现** | 自动扫描并列出所有可用的 PRO-XXXX 设备 | 快速定位目标设备 |
| **连接管理** | 维持稳定的 BLE 连接并显示状态 | 确保更新过程稳定 |
| **进度可视化** | 实时显示固件传输进度和状态 | 用户了解更新进展 |
| **测试验证** | 发送测试命令验证设备响应 | 更新前确认设备正常 |

### 1.3 系统定位

```
开发环境
    ↓
OTA GUI 系统（本模块）
    ├── 固件编译子系统
    ├── BLE 通信子系统
    └── 用户界面子系统
         ↓
    Riz 设备群
```

OTA GUI 系统作为开发环境与设备之间的桥梁，将复杂的固件更新流程简化为图形化操作。

---

## 2. 核心设计原则

### 2.1 原则 #1: 安全第一，防止误操作

**核心理念**: 固件更新是高风险操作，任何失误都可能导致设备变砖。系统通过多重确认和状态检查机制，确保更新过程的安全性。

**具体要求**:
- 更新前必须验证设备型号和当前版本
- 提供明确的警告和确认对话框
- 支持更新中断和恢复机制
- 记录所有操作日志便于问题追溯

### 2.2 原则 #2: 流程透明，状态可见

**核心理念**: 用户需要清楚了解更新过程的每个阶段，包括当前进度、预计时间和可能的问题。

**具体要求**:
- 显示详细的步骤进度：编译中、连接中、传输中
- 实时更新传输百分比和速度
- 异常情况立即反馈并提供解决建议
- 保留历史更新记录供查阅

### 2.3 原则 #3: 操作简化，降低门槛

**核心理念**: 将技术复杂度封装在系统内部，让非技术人员也能完成固件更新任务。

**具体要求**:
- 图形界面直观易懂，避免技术术语
- 自动处理依赖和环境配置
- 提供一键式操作流程
- 智能推荐和默认值设置

---

## 3. 模块结构与组成

### 3.1 整体结构

```
OTA GUI 更新系统
├── 界面层：主窗口、设备列表、进度显示、日志输出
├── 编译层：PlatformIO 集成、固件生成、版本管理
├── 通信层：BLE 扫描、连接管理、数据传输
├── 控制层：流程协调、状态管理、错误处理
└── 存储层：配置保存、日志记录、固件缓存
```

### 3.2 核心组件

**组件 #1: 设备扫描器**
- 功能：定期扫描周围的 BLE 设备，筛选出 PRO-XXXX 格式的目标设备
- 特性：显示设备名称、信号强度、MAC 地址和连接状态

**组件 #2: 固件编译器**
- 功能：集成 PlatformIO 工具链，自动编译项目源码生成二进制固件
- 特性：检测代码变更、管理编译配置、输出编译日志

**组件 #3: 传输管理器**
- 功能：将固件文件分片并通过 BLE 传输到设备
- 特性：512 字节分片、进度追踪、断点续传、校验确认

**组件 #4: 状态监控器**
- 功能：实时监控更新过程各阶段状态并更新界面显示
- 特性：阶段指示、错误捕获、日志记录、通知提醒

### 3.3 组件协同

各组件通过事件驱动机制协同工作：设备扫描器发现设备后通知界面更新列表，用户选择设备后控制层协调编译器生成固件，然后指挥传输管理器建立连接并传输数据，整个过程由状态监控器跟踪并反馈给用户。

---

## 4. 用户体验流程

### 4.1 核心用户旅程

【场景】开发者完成代码修改后，需要将新固件更新到测试设备

步骤 1: 启动 OTA GUI 应用
    → 主界面显示，自动开始扫描设备
    → 设备列表显示发现的 PRO-1234、PRO-5678 等设备
    → 状态栏显示"就绪"

步骤 2: 编译最新固件
    → 点击"编译固件"按钮
    → 进度条显示编译进度，日志窗口输出编译信息
    → 编译成功后显示固件版本号和大小

步骤 3: 选择目标设备
    → 从列表中选择 PRO-1234
    → 点击"连接"按钮
    → 连接成功后设备状态变为"已连接"

步骤 4: 测试设备响应
    → 点击"发送测试信号"
    → 设备 LED 闪烁蓝色表示响应正常
    → 日志显示"设备响应正常"

步骤 5: 开始固件更新
    → 点击"开始更新"按钮
    → 确认对话框提示当前版本和目标版本
    → 确认后开始传输，进度条显示百分比
    → 更新完成后设备自动重启

### 4.2 典型使用场景

**场景 1: 批量设备更新**

**用户背景**: 生产部门需要给 10 台新设备刷入固件

**用户体验**:
1. 打开应用，设备列表显示所有待更新设备
2. 使用"全选"功能选中所有设备
3. 点击"批量更新"，系统依次更新每台设备
4. 更新完成后生成报告，显示成功和失败设备清单

**关键价值**: 将原本需要逐台手动更新的流程简化为一键批量操作

**场景 2: 问题设备修复**

**用户背景**: 现场设备出现异常，需要重新刷入稳定版固件

**用户体验**:
1. 选择"固件版本"下拉框，选择上一个稳定版本
2. 连接问题设备（可能需要进入 DFU 模式）
3. 执行强制更新，跳过版本检查
4. 更新完成后验证设备功能恢复正常

**关键价值**: 提供固件回滚能力，快速恢复设备到已知良好状态

---

## 5. 模块定位与关系

### 5.1 与其他工具的区别

| 维度 | OTA GUI | 命令行工具 | 手机 App OTA | Web 界面 |
|------|----------|------------|-------------|----------|
| **目标用户** | 开发/测试人员 | 开发人员 | 终端用户 | 所有用户 |
| **使用门槛** | 低（图形界面） | 高（命令行） | 低（简化功能） | 中等 |
| **功能完整性** | 完整 | 完整 | 基础 | 中等 |
| **环境要求** | 桌面系统 | 开发环境 | 手机 | 浏览器 |
| **批量能力** | 支持 | 脚本支持 | 不支持 | 部分支持 |

### 5.2 协同方式

**与 PlatformIO 的协同**:
GUI 应用调用 PlatformIO CLI → 读取 platformio.ini 配置 →
编译源码生成 .bin 文件 → 读取固件到内存 → 准备传输

**与 BLE 协议栈的协同**:
GUI 使用系统 BLE API → 扫描设备广播 → 建立 GATT 连接 →
发现 OTA 服务和特征 → 分片写入固件数据 → 接收确认响应

### 5.3 核心价值

**对用户的价值**:
1. 降低技术门槛 - 无需掌握命令行和编译知识
2. 提高更新效率 - 批量更新和自动化流程
3. 减少操作错误 - 图形界面和状态提示降低误操作

**对产品的价值**:
1. 加速迭代周期 - 快速部署新版本到测试设备
2. 提升产品质量 - 便于测试不同固件版本
3. 优化支持体验 - 现场支持人员可快速解决固件问题

---

## 📂 相关文档

- 📘 [蓝牙通信协议规范](../docs/protocol/蓝牙通信协议规范.md)
- 📙 [OTA 实现细节](../src/OTA.cpp)
- 📗 [开发者实施指南](../docs/protocol/开发者实施指南.md)

---

## 附录 A: 版本历史

| 版本号 | 更新日期 | 作者 | 主要变更内容 |
|--------|----------|------|-------------|
| v1.0.0 | 2025-11-23 | Klean | 初始版本，定义 OTA GUI 核心概念和设计原则 |
| - | - | - | - |
| - | - | - | - |
| - | - | - | - |
| - | - | - | - |

**版本变更说明**：
- 每次更新时，将新版本添加到表格顶部
- 仅保留最近 5 次版本记录
- 主要变更内容应简洁明确（不超过 20 字）

---

**文档维护**: Riz 产品团队
**最后更新**: 2025-11-23