# RizSimulator 产品需求文档 (PRD)

## 1. 产品概述

### 1.1 产品名称
**RizSimulator** - Riz反应灯ESP32设备模拟器

### 1.2 产品背景
Riz是一套基于ESP32的智能反应灯训练系统，用于运动员的反应速度和敏捷性训练。为了提升开发效率、测试覆盖率以及降低硬件依赖，我们需要一个能够完整模拟Riz设备行为的软件模拟器。

### 1.3 产品定位
RizSimulator是一款Python GUI桌面应用程序，能够：
- 完整模拟Riz ESP32设备的蓝牙BLE通信协议
- 模拟多个反应灯设备的并发运行
- 提供可视化的灯光显示和控制界面
- 支持与iOS/Android应用程序的实时交互

### 1.4 目标用户
- **主要用户**：移动应用开发工程师
- **次要用户**：QA测试人员、产品经理、算法工程师
- **潜在用户**：技术支持人员、培训师

### 1.5 核心价值
1. **开发提效**：无需实体硬件即可进行App功能开发和调试
2. **测试增强**：支持批量设备模拟，提高测试场景覆盖
3. **成本降低**：减少硬件采购和维护成本
4. **协作改善**：多团队可并行开发，不受硬件数量限制

## 2. 功能需求

### 2.1 核心功能模块

#### 2.1.1 设备模拟管理
**功能描述**：管理和控制多个虚拟Riz设备实例

**详细需求**：
- 默认创建1个设备实例
- 支持动态增加/减少设备（范围：1-20个）
- 每个设备独立的：
  - MAC地址（自动生成，格式：AA:BB:CC:DD:XX:YY）
  - 设备名称（格式：RIZ-XXXX）
  - 设备ID（唯一标识符）
- 设备状态管理：
  - 未连接（灰色指示）
  - 广播中（蓝色闪烁）
  - 已连接（绿色常亮）
  - 错误状态（红色）

#### 2.1.2 蓝牙BLE通信模拟
**功能描述**：完整实现ESP32的BLE GATT服务

**详细需求**：
- BLE广播功能：
  - 广播名称：RIZ-XXXX
  - 广播间隔：100ms
  - 广播数据包含设备信息
- GATT服务实现：
  ```
  主服务UUID: 4fafc201-1fb5-459e-8fcc-c5c9c331914b

  特征值：
  - 控制特征值: beb5483e-36e1-4688-b7f5-ea07361b26a8
    权限：READ, WRITE, NOTIFY
  - 状态特征值: cba1d466-344c-4be3-ab3f-189f80dd7518
    权限：READ, NOTIFY
  - 传感器特征值: e3223119-9445-4e96-a4a1-85358c4046a2
    权限：READ, NOTIFY
  ```
- 支持的BLE操作：
  - 连接/断开连接
  - 读取特征值
  - 写入特征值
  - 订阅通知
  - MTU协商（默认247字节）

#### 2.1.3 灯光显示与控制
**功能描述**：可视化显示每个设备的灯光状态

**详细需求**：
- 灯光显示组件：
  - 圆形LED指示器（直径100px）
  - 支持RGB全彩显示
  - 亮度调节（0-255级）
  - 闪烁频率控制
- 灯光模式：
  - 静态颜色模式
  - 呼吸灯模式
  - 闪烁模式
  - 流水灯模式（多设备）
  - 自定义序列模式
- 实时响应：
  - 接收命令到灯光变化 < 50ms
  - 支持批量控制

#### 2.1.4 训练模式模拟
**功能描述**：模拟实际训练场景中的设备行为

**支持的训练模式**：
1. **反应训练模式**
   - 随机点亮设备
   - 检测"拍打"动作（模拟按钮）
   - 记录反应时间
   - 自动切换下一个目标

2. **序列训练模式**
   - 按预设序列点亮
   - 支持导入序列配置
   - 循环/单次执行

3. **节奏训练模式**
   - 按固定节奏闪烁
   - BPM可调（60-180）
   - 多设备同步/异步

4. **自由训练模式**
   - 手动控制每个设备
   - 实时调整参数

#### 2.1.5 数据模拟与上报
**功能描述**：模拟传感器数据和训练数据

**模拟数据类型**：
- 毫米波雷达数据：
  - 距离检测（0-6000mm）
  - 运动检测（静止/运动）
  - 目标数量（0-5）
- TOF激光测距：
  - 精确距离（30-2000mm）
  - 信号强度
- 训练数据：
  - 触发时间戳
  - 反应时间（ms）
  - 命中准确度
  - 连击次数
- 设备状态：
  - 电池电量（0-100%）
  - 温度（-20~85°C）
  - 固件版本

### 2.2 GUI界面设计

#### 2.2.1 主界面布局
```
┌────────────────────────────────────────────────────────────────┐
│  RizSimulator v1.0.0           [最小化] [最大化] [关闭]       │
├────────────────────────────────────────────────────────────────┤
│ 菜单栏：文件 | 设备 | 训练 | 工具 | 帮助                        │
├────────────────────────────────────────────────────────────────┤
│ 工具栏：[➕添加设备] [➖删除设备] [▶️全部启动] [⏸️全部停止]      │
├─────────────────┬──────────────────────────────────────────────┤
│                 │                                              │
│   设备列表      │              设备显示区域                     │
│                 │                                              │
│ ┌─────────────┐ │  ┌────┐  ┌────┐  ┌────┐  ┌────┐           │
│ │☑ RIZ-0001  │ │  │ 01 │  │ 02 │  │ 03 │  │ 04 │           │
│ │  状态：已连接│ │  └────┘  └────┘  └────┘  └────┘           │
│ │☑ RIZ-0002  │ │                                              │
│ │  状态：广播中│ │  ┌────┐  ┌────┐  ┌────┐  ┌────┐           │
│ │☐ RIZ-0003  │ │  │ 05 │  │ 06 │  │ 07 │  │ 08 │           │
│ │  状态：未连接│ │  └────┘  └────┘  └────┘  └────┘           │
│ └─────────────┘ │                                              │
│                 │  当前设备数：8  已连接：3  广播中：2          │
├─────────────────┴──────────────────────────────────────────────┤
│ 控制面板                                                        │
│ ┌──────────────┬─────────────────┬──────────────────────────┐ │
│ │ 颜色控制     │ 模式选择        │ 参数设置                 │ │
│ │ [颜色选择器] │ ○反应 ○序列    │ 亮度：[━━━━━━━━━] 80%   │ │
│ │ R:[255]      │ ○节奏 ○自由    │ 闪烁频率：[━━━━━] 5Hz    │ │
│ │ G:[255]      │                 │ 延迟时间：[100]ms        │ │
│ │ B:[255]      │ [应用到所有]    │                          │ │
│ └──────────────┴─────────────────┴──────────────────────────┘ │
├────────────────────────────────────────────────────────────────┤
│ 日志输出                                               [清除]  │
│ ┌──────────────────────────────────────────────────────────┐ │
│ │2024-11-23 10:00:01 [INFO] 系统启动完成                   │ │
│ │2024-11-23 10:00:05 [BLE] RIZ-0001 开始广播               │ │
│ │2024-11-23 10:00:12 [BLE] 手机已连接到 RIZ-0001           │ │
│ │2024-11-23 10:00:15 [CMD] 收到命令: SET_COLOR RGB(255,0,0)│ │
│ └──────────────────────────────────────────────────────────┘ │
├────────────────────────────────────────────────────────────────┤
│ 状态栏：CPU: 15% | 内存: 256MB | 设备数: 8 | 运行时间: 00:05:23│
└────────────────────────────────────────────────────────────────┘
```

#### 2.2.2 设备详情面板
点击单个设备时弹出的详情面板：
```
┌─────────────────────────────────────┐
│        设备详情 - RIZ-0001         X│
├─────────────────────────────────────┤
│ 基本信息：                          │
│   MAC地址：AA:BB:CC:DD:00:01       │
│   固件版本：v1.0.0                  │
│   连接状态：已连接                   │
│   信号强度：-65 dBm                 │
│                                     │
│ 传感器数据：                        │
│   毫米波距离：1250 mm               │
│   TOF距离：450 mm                   │
│   电池电量：85%                     │
│   设备温度：28°C                    │
│                                     │
│ 训练统计：                          │
│   总触发次数：156                   │
│   平均反应时间：325ms               │
│   最快反应：215ms                  │
│                                     │
│ 操作：                              │
│ [模拟触发] [断开连接] [重置数据]    │
└─────────────────────────────────────┘
```

### 2.3 高级功能

#### 2.3.1 批量操作
- 全选/反选设备
- 批量设置参数
- 批量启动/停止
- 分组管理

#### 2.3.2 数据记录与分析
- 实时数据记录
- 导出CSV/JSON格式
- 性能统计图表
- 会话回放功能

#### 2.3.3 脚本支持
- Python脚本接口
- 自动化测试脚本
- 场景配置文件
- 命令行控制

#### 2.3.4 调试工具
- BLE数据包分析
- 十六进制查看器
- 协议解码器
- 性能分析器

## 3. 非功能性需求

### 3.1 性能需求
| 指标 | 要求 | 备注 |
|------|------|------|
| 启动时间 | < 3秒 | 冷启动 |
| 响应延迟 | < 50ms | 命令处理 |
| 最大设备数 | 20个 | 同时模拟 |
| CPU占用 | < 25% | 正常运行 |
| 内存占用 | < 500MB | 20个设备 |
| 帧率 | > 30 FPS | GUI刷新 |

### 3.2 可用性需求
- 界面响应流畅，无卡顿
- 支持拖拽操作
- 快捷键支持
- 自动保存配置
- 崩溃恢复机制

### 3.3 兼容性需求
- **操作系统**：
  - Windows 10/11 (64位)
  - macOS 11.0+
  - Ubuntu 20.04+
- **Python版本**：3.8 - 3.11
- **屏幕分辨率**：最低1280x720

### 3.4 安全性需求
- 数据传输加密（可选）
- 访问控制（可选）
- 日志脱敏
- 防止恶意命令注入

## 4. 技术实现方案

### 4.1 技术架构
```
┌──────────────────────────────────────────┐
│          应用层 (Application Layer)        │
│          PyQt6 GUI Framework             │
├──────────────────────────────────────────┤
│         业务逻辑层 (Business Logic)        │
│   设备管理 | 协议处理 | 状态机 | 数据处理   │
├──────────────────────────────────────────┤
│         通信层 (Communication Layer)       │
│      Bleak (BLE) | asyncio | Queue       │
├──────────────────────────────────────────┤
│          系统层 (System Layer)            │
│    日志系统 | 配置管理 | 数据持久化         │
└──────────────────────────────────────────┘
```

### 4.2 关键技术选型
- **GUI框架**：PyQt6
- **BLE库**：bleak（跨平台BLE）
- **异步框架**：asyncio
- **数据处理**：pandas, numpy
- **可视化**：matplotlib（图表）
- **打包工具**：PyInstaller

### 4.3 核心模块设计

#### 4.3.1 设备模拟器核心
```python
class RizDevice:
    """Riz设备模拟器核心类"""
    def __init__(self, device_id: str):
        self.device_id = device_id
        self.mac_address = self.generate_mac()
        self.name = f"RIZ-{device_id:04d}"
        self.state = DeviceState.DISCONNECTED
        self.light_state = LightState()
        self.sensor_data = SensorData()

    async def start_advertising(self):
        """开始BLE广播"""
        pass

    async def handle_connection(self):
        """处理连接请求"""
        pass

    def process_command(self, command: bytes):
        """处理接收到的命令"""
        pass
```

#### 4.3.2 通信协议
```python
# 命令格式定义
COMMAND_FORMAT = {
    'HEADER': 0xAA55,  # 2字节
    'CMD': 1,          # 1字节
    'LENGTH': 2,       # 2字节
    'PAYLOAD': 'n',    # n字节
    'CRC': 2          # 2字节
}

# 命令类型
class Commands:
    SET_COLOR = 0x01
    SET_BRIGHTNESS = 0x02
    SET_MODE = 0x03
    GET_STATUS = 0x10
    GET_SENSOR = 0x11
    TRIGGER_EVENT = 0x20
```

## 5. 项目计划

### 5.1 开发阶段划分

#### Phase 1: 基础架构（第1-2周）
- [x] 项目结构搭建
- [ ] GUI基础框架
- [ ] 设备管理模块
- [ ] 配置系统

#### Phase 2: BLE通信（第3-4周）
- [ ] BLE广播实现
- [ ] GATT服务搭建
- [ ] 连接管理
- [ ] 数据传输

#### Phase 3: 设备模拟（第5-6周）
- [ ] 灯光控制
- [ ] 传感器模拟
- [ ] 状态管理
- [ ] 训练模式

#### Phase 4: 高级功能（第7-8周）
- [ ] 批量操作
- [ ] 数据分析
- [ ] 脚本接口
- [ ] 性能优化

#### Phase 5: 测试发布（第9-10周）
- [ ] 集成测试
- [ ] 性能测试
- [ ] 文档编写
- [ ] 打包发布

### 5.2 里程碑
| 里程碑 | 时间 | 交付物 |
|--------|------|--------|
| M1 | 第2周 | 基础GUI可运行 |
| M2 | 第4周 | BLE通信完成 |
| M3 | 第6周 | 核心功能完成 |
| M4 | 第8周 | 全功能版本 |
| M5 | 第10周 | v1.0正式发布 |

## 6. 测试策略

### 6.1 测试类型
1. **单元测试**
   - 覆盖率目标：>85%
   - 测试框架：pytest

2. **集成测试**
   - BLE通信测试
   - 多设备并发测试
   - 长时间稳定性测试

3. **性能测试**
   - 20设备并发
   - 24小时稳定运行
   - 内存泄漏检查

4. **兼容性测试**
   - 多操作系统
   - 多Python版本
   - 不同手机App

### 6.2 测试用例示例
```
TC001: 设备添加测试
前置条件：应用已启动
测试步骤：
1. 点击"添加设备"按钮
2. 输入设备参数
3. 确认添加
预期结果：设备成功添加到列表

TC002: BLE连接测试
前置条件：设备已创建
测试步骤：
1. 启动设备广播
2. 手机App扫描连接
3. 验证连接状态
预期结果：连接成功，状态更新
```

## 7. 风险管理

### 7.1 技术风险
| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| BLE库兼容性问题 | 中 | 高 | 准备备选方案，提前测试 |
| 性能达不到要求 | 低 | 中 | 优化算法，使用C扩展 |
| GUI响应延迟 | 中 | 中 | 使用异步处理，优化渲染 |

### 7.2 项目风险
| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 需求变更 | 高 | 中 | 敏捷开发，快速迭代 |
| 进度延期 | 中 | 中 | 预留缓冲时间 |
| 资源不足 | 低 | 高 | 提前申请资源 |

## 8. 成功标准

### 8.1 功能完整性
- ✅ 100%实现PRD定义的核心功能
- ✅ 95%实现高级功能
- ✅ 通过所有测试用例

### 8.2 性能指标
- ✅ 响应时间 < 50ms
- ✅ 支持20个设备并发
- ✅ CPU占用 < 25%
- ✅ 内存占用 < 500MB

### 8.3 质量指标
- ✅ 代码覆盖率 > 85%
- ✅ 无严重Bug
- ✅ 文档完整性 > 90%

### 8.4 用户满意度
- ✅ 易用性评分 > 4.0/5.0
- ✅ 稳定性评分 > 4.5/5.0
- ✅ 功能满意度 > 4.0/5.0

## 9. 附录

### 9.1 术语定义
- **Riz**：反应灯训练系统品牌
- **ESP32**：乐鑫科技的Wi-Fi+蓝牙MCU
- **BLE**：Bluetooth Low Energy，低功耗蓝牙
- **GATT**：Generic Attribute Profile
- **UUID**：Universally Unique Identifier
- **MTU**：Maximum Transmission Unit

### 9.2 参考资料
1. ESP32 BLE开发指南
2. Bleak官方文档
3. PyQt6开发手册
4. 现有Riz固件通信协议

### 9.3 联系方式
- 产品经理：[PM Name]
- 技术负责人：[Tech Lead]
- 项目群组：[Group Link]

---

**文档信息**
- 版本：v1.0.0
- 状态：评审中
- 创建日期：2024-11-23
- 最后更新：2024-11-23
- 下次评审：2024-11-30

**修订历史**
| 版本 | 日期 | 作者 | 修改说明 |
|------|------|------|----------|
| v1.0.0 | 2024-11-23 | RizSimulator Team | 初始版本创建 |